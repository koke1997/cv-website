---
- name: Fix CV Site Styling and Images
  hosts: local
  gather_facts: no
  # Variables loaded from ansible/inventory/group_vars/all.yml
  
  tasks:
    - name: Stop server
      ansible.builtin.shell:
        cmd: "lsof -ti:8080 | xargs kill -9"
      ignore_errors: yes
    
    - name: Create proper CSS with complete styling
      ansible.builtin.copy:
        dest: "{{ docs_dir }}/stylesheets/extra.css"
        content: |
          /* Profile Section */
          .profile-container {
              text-align: center;
              margin: 3rem 0;
          }
          
          .profile-image {
              width: 200px;
              height: 200px;
              border-radius: 50%;
              object-fit: cover;
              border: 4px solid #2196f3;
              box-shadow: 0 8px 16px rgba(0,0,0,0.2);
              margin: 0 auto 1.5rem;
              display: block;
          }
          
          /* Stats Container */
          .stats-container {
              display: grid;
              grid-template-columns: repeat(4, 1fr);
              gap: 1.5rem;
              margin: 2rem 0;
          }
          
          .stat-card {
              background: linear-gradient(135deg, #2196f3, #1976d2);
              color: white;
              padding: 2rem;
              border-radius: 12px;
              text-align: center;
              box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          }
          
          .stat-number {
              font-size: 2.5rem;
              font-weight: 700;
              margin-bottom: 0.5rem;
              display: block;
          }
          
          .stat-label {
              font-size: 0.9rem;
              opacity: 0.95;
              display: block;
          }
          
          /* Skills Grid */
          .skills-grid {
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 1.5rem;
              margin: 2rem 0;
          }
          
          .skill-card {
              background: var(--md-default-bg-color);
              border: 1px solid var(--md-default-fg-color--lightest);
              border-radius: 8px;
              padding: 1.5rem;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }
          
          .skill-name {
              font-weight: 600;
              margin-bottom: 0.8rem;
              color: #2196f3;
              font-size: 1rem;
          }
          
          .skill-bar {
              height: 8px;
              background: rgba(33, 150, 243, 0.1);
              border-radius: 4px;
              overflow: hidden;
          }
          
          .skill-progress {
              height: 100%;
              background: linear-gradient(90deg, #2196f3, #1976d2);
              border-radius: 4px;
              transition: width 1s ease;
          }
          
          /* Download Grid */
          .download-grid {
              display: grid;
              grid-template-columns: repeat(4, 1fr);
              gap: 1.5rem;
              margin: 2rem 0;
          }
          
          .download-card {
              background: var(--md-default-bg-color);
              border: 2px solid #2196f3;
              border-radius: 12px;
              padding: 2rem;
              text-align: center;
              transition: all 0.3s ease;
          }
          
          .download-card:hover {
              transform: translateY(-5px);
              box-shadow: 0 8px 16px rgba(33, 150, 243, 0.3);
          }
          
          .download-icon {
              font-size: 3rem;
              margin-bottom: 1rem;
          }
          
          /* Contact Form */
          .contact-form {
              max-width: 700px;
              margin: 2rem auto;
              padding: 2rem;
              background: var(--md-default-bg-color);
              border-radius: 12px;
              box-shadow: 0 4px 8px rgba(0,0,0,0.1);
          }
          
          .form-group {
              margin-bottom: 1.5rem;
          }
          
          .form-group label {
              display: block;
              margin-bottom: 0.5rem;
              font-weight: 600;
              color: #2196f3;
          }
          
          .form-group input,
          .form-group select,
          .form-group textarea {
              width: 100%;
              padding: 0.75rem;
              border: 2px solid #ddd;
              border-radius: 6px;
              font-size: 1rem;
              font-family: inherit;
              transition: border-color 0.3s;
          }
          
          .form-group input:focus,
          .form-group select:focus,
          .form-group textarea:focus {
              outline: none;
              border-color: #2196f3;
          }
          
          .form-group.required label::after {
              content: " *";
              color: #f44336;
          }
          
          .submit-btn {
              background: #2196f3;
              color: white;
              padding: 1rem 2rem;
              border: none;
              border-radius: 6px;
              font-size: 1rem;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.3s;
              width: 100%;
          }
          
          .submit-btn:hover {
              background: #1976d2;
              transform: translateY(-2px);
              box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
          }
          
          /* Responsive */
          @media (max-width: 768px) {
              .stats-container,
              .skills-grid,
              .download-grid {
                  grid-template-columns: 1fr;
              }
          }
          
          @media (max-width: 1024px) {
              .stats-container {
                  grid-template-columns: repeat(2, 1fr);
              }
              .skills-grid {
                  grid-template-columns: repeat(2, 1fr);
              }
              .download-grid {
                  grid-template-columns: repeat(2, 1fr);
              }
          }
    
    - name: Rebuild site completely
      ansible.builtin.shell:
        cmd: |
          source {{ venv_dir }}/bin/activate
          mkdocs build --clean --strict
        chdir: "{{ project_dir }}"
      register: build_result
    
    - name: Start server
      ansible.builtin.shell:
        cmd: |
          source {{ venv_dir }}/bin/activate
          nohup mkdocs serve -a 127.0.0.1:8080 > /tmp/mkdocs_cv.log 2>&1 &
          echo $! > /tmp/mkdocs_cv.pid
        chdir: "{{ project_dir }}"
    
    - name: Wait for server
      ansible.builtin.wait_for:
        port: 8080
        delay: 2
        timeout: 10
    
    - name: Success message
      ansible.builtin.debug:
        msg:
          - "âœ… Site fixed and rebuilt!"
          - "ğŸŒ Open http://127.0.0.1:8080/"
          - "ğŸ”„ Hard refresh (Cmd+Shift+R) to see changes"
